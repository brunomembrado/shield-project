name: Build and Push to AWS ECR

on:
    push:
        branches:
            - main
            - master
            - develop
        paths:
            - "services/**"
            - "shared/**"
            - ".github/workflows/deploy-to-ecr.yml"
    workflow_dispatch:

env:
    AWS_REGION: us-east-2
    ECR_REGISTRY: 356536471067.dkr.ecr.us-east-2.amazonaws.com
    ECR_REPOSITORY: shield-project

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            auth-service: ${{ steps.filter.outputs.auth-service }}
            blockchain-service: ${{ steps.filter.outputs.blockchain-service }}
            wallet-service: ${{ steps.filter.outputs.wallet-service }}
            shared: ${{ steps.filter.outputs.shared }}
        steps:
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@v2
              id: filter
              with:
                  filters: |
                      auth-service:
                        - 'services/auth-service/**'
                        - 'shared/**'
                      blockchain-service:
                        - 'services/blockchain-service/**'
                        - 'shared/**'
                      wallet-service:
                        - 'services/wallet-service/**'
                        - 'shared/**'
                      shared:
                        - 'shared/**'

    build-auth-service:
        needs: detect-changes
        if: needs.detect-changes.outputs.auth-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build, tag, and push Auth Service image
              env:
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:auth-service-${{ env.IMAGE_TAG }} \
                    --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:auth-service-latest \
                    --file services/auth-service/Dockerfile \
                    --push \
                    ./services/auth-service

                  echo "âœ… Auth Service image pushed successfully"
                  echo "Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:auth-service-${{ env.IMAGE_TAG }}"

    build-blockchain-service:
        needs: detect-changes
        if: needs.detect-changes.outputs.blockchain-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build, tag, and push Blockchain Service image
              env:
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:blockchain-service-${{ env.IMAGE_TAG }} \
                    --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:blockchain-service-latest \
                    --file services/blockchain-service/Dockerfile \
                    --push \
                    ./services/blockchain-service

                  echo "âœ… Blockchain Service image pushed successfully"
                  echo "Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:blockchain-service-${{ env.IMAGE_TAG }}"

    build-wallet-service:
        needs: detect-changes
        if: needs.detect-changes.outputs.wallet-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build, tag, and push Wallet Service image
              env:
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:wallet-service-${{ env.IMAGE_TAG }} \
                    --tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:wallet-service-latest \
                    --file services/wallet-service/Dockerfile \
                    --push \
                    ./services/wallet-service

                  echo "âœ… Wallet Service image pushed successfully"
                  echo "Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:wallet-service-${{ env.IMAGE_TAG }}"

    deployment-summary:
        needs:
            [build-auth-service, build-blockchain-service, build-wallet-service]
        if: always()
        runs-on: ubuntu-latest
        steps:
            - name: Deployment Summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**ECR Registry:** ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Services Built:" >> $GITHUB_STEP_SUMMARY
                  echo "- Auth Service: ${{ needs.build-auth-service.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Blockchain Service: ${{ needs.build-blockchain-service.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Wallet Service: ${{ needs.build-wallet-service.result }}" >> $GITHUB_STEP_SUMMARY
