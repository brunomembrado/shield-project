// Prisma schema for Shield Transaction Service
// This service manages USDT payment transactions and their lifecycle

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Chain types supported by Shield platform
enum ChainType {
  POLYGON  // Polygon (MATIC) network
  TRON     // Tron network
}

/// Transaction status lifecycle
enum TransactionStatus {
  PENDING              // Transaction initiated, awaiting payment
  PAYMENT_RECEIVED     // USDT received on blockchain
  VALIDATING           // Validating transaction on blockchain
  COMPLIANCE_CHECK     // Running compliance checks
  APPROVED             // Compliance approved
  WIRE_SUBMITTED       // USD wire transfer submitted to bank
  WIRE_PROCESSED       // USD received in client's bank account
  FAILED               // Transaction failed
  REJECTED             // Compliance rejected
}

/// Transaction model represents a USDT payment transaction
model Transaction {
  /// Unique identifier (UUID v4)
  id String @id @default(uuid())
  
  /// Foreign key to User (from auth-service)
  userId String @map("user_id")
  
  /// Foreign key to Wallet
  walletId String @map("wallet_id")
  
  /// Blockchain network
  chain ChainType
  
  /// Transaction hash on blockchain (set when payment received)
  txHash String? @unique @map("tx_hash")
  
  /// Sender address (from blockchain)
  fromAddress String? @map("from_address")
  
  /// Recipient address (Shield wallet)
  toAddress String @map("to_address")
  
  /// Amount in USDT (as string to maintain precision)
  amountUSDT String @map("amount_usdt")
  
  /// Amount in USD (converted from USDT)
  amountUSD String @map("amount_usd")
  
  /// Exchange rate used (USDT to USD)
  exchangeRate String @map("exchange_rate")
  
  /// Service fee percentage (default: 1%)
  serviceFeePercentage String @map("service_fee_percentage") @default("1")
  
  /// Service fee amount in USD
  serviceFee String @map("service_fee")
  
  /// Net amount after fee deduction (USD)
  netAmount String @map("net_amount")
  
  /// Transaction status
  status TransactionStatus
  
  /// Bank account name for wire transfer
  bankAccountName String? @map("bank_account_name")
  
  /// Bank account number for wire transfer
  bankAccountNumber String? @map("bank_account_number")
  
  /// Bank routing number (for US banks)
  bankRoutingNumber String? @map("bank_routing_number")
  
  /// Bank wire reference/confirmation number
  bankWireReference String? @map("bank_wire_reference")
  
  /// Compliance check ID (from compliance-service)
  complianceCheckId String? @map("compliance_check_id")
  
  /// Compliance status
  complianceStatus String? @map("compliance_status")
  
  /// Additional notes
  notes String?
  
  /// Timestamp when transaction was created
  createdAt DateTime @default(now()) @map("created_at")
  
  /// Timestamp when transaction was last updated
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("transactions")
  @@index([userId])
  @@index([walletId])
  @@index([chain])
  @@index([status])
  @@index([txHash])
  @@index([createdAt])
}

